#!/usr/bin/env sh
set -e

branch="$(git symbolic-ref --quiet --short HEAD || true)"

if [ "$branch" = "main" ] || [ "$branch" = "master" ]; then
  if [ "${ALLOW_MAIN_COMMIT:-}" != "true" ]; then
    echo "Commit bloqueado: branch protegida ($branch)."
    echo "Use uma branch de trabalho, por exemplo:"
    echo "  git checkout -b feat/minha-melhoria"
    echo "Bypass de emergencia (uso excepcional):"
    echo "  ALLOW_MAIN_COMMIT=true git commit -m \"...\""
    exit 1
  fi
fi

if command -v npm >/dev/null 2>&1; then
  echo "Running staged quality checks..."
  npm run format:check:staged
  npm run encoding:check:staged
else
  echo "npm not found. Skipping staged quality checks."
fi
