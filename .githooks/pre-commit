#!/usr/bin/env sh
set -e

branch="$(git symbolic-ref --quiet --short HEAD || true)"

if [ "$branch" = "main" ] || [ "$branch" = "master" ]; then
  if [ "${ALLOW_MAIN_COMMIT:-}" != "true" ]; then
    echo "Commit blocked: protected branch ($branch)."
    echo "Use a feature branch, for example:"
    echo "  git checkout -b feat/my-change"
    echo "Emergency bypass (exceptional use only):"
    echo "  ALLOW_MAIN_COMMIT=true git commit -m \"...\""
    exit 1
  fi
fi

if ! command -v npm >/dev/null 2>&1; then
  echo "npm not found. Skipping workspace quality checks."
  exit 0
fi

staged_files="$(git diff --cached --name-only --diff-filter=ACMR)"

if [ -z "$staged_files" ]; then
  exit 0
fi

run_aurea=0
run_white_label=0

for file in $staged_files; do
  case "$file" in
    apps/aurea/*|packages/db-aurea/*)
      run_aurea=1
      ;;
    apps/white-label/*|packages/db-white-label/*)
      run_white_label=1
      ;;
    *)
      run_aurea=1
      run_white_label=1
      ;;
  esac
done

if [ "$run_aurea" -eq 1 ]; then
  echo "Running precommit checks for Aurea..."
  npm run precommit:check:aurea
fi

if [ "$run_white_label" -eq 1 ]; then
  echo "Running precommit checks for White Label..."
  npm run precommit:check:wl
fi
